{% extends "base.html" %}

{% block title %}实时日志 - 网站监控系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-terminal me-2"></i>实时监控日志</h2>
            <div>
                <button class="btn btn-outline-success me-2" onclick="toggleAutoRefresh()">
                    <i class="fas fa-play me-1" id="auto-refresh-icon"></i>
                    <span id="auto-refresh-text">开启自动刷新</span>
                </button>
                <button class="btn btn-outline-primary me-2" onclick="refreshLogs()">
                    <i class="fas fa-sync-alt me-1"></i>手动刷新
                </button>
                <button class="btn btn-outline-danger" onclick="clearLogs()">
                    <i class="fas fa-trash me-1"></i>清空显示
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 状态指示器 -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <div class="me-3">
                <span class="status-indicator status-active"></span>
                系统运行中
            </div>
            <div class="me-3">
                <i class="fas fa-clock me-1"></i>
                最后更新: <span id="last-update-time">--</span>
            </div>
            <div class="me-3">
                <i class="fas fa-eye me-1"></i>
                日志条数: <span id="log-count">0</span>
            </div>
            <div class="ms-auto">
                <small class="text-muted">每10秒自动刷新</small>
            </div>
        </div>
    </div>
</div>

<!-- 日志显示区域 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>监控活动日志
                </h5>
            </div>
            <div class="card-body p-0" style="height: 600px; overflow-y: auto;">
                <div id="logs-container" class="p-3">
                    <div class="text-center text-muted">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载日志...</p>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    显示最近50条监控活动记录
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshEnabled = false;
let autoRefreshInterval = null;
let lastLogId = 0;

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    refreshLogs();
});

// 刷新日志
function refreshLogs() {
    fetch('/api/logs?limit=50')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayLogs(data.logs);
                updateStatus(data.total);
            } else {
                showError('获取日志失败');
            }
        })
        .catch(error => {
            showError('网络错误: ' + error.message);
        });
}

// 显示日志
function displayLogs(logs) {
    const container = document.getElementById('logs-container');

    if (logs.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>暂无监控日志</p>
            </div>
        `;
        return;
    }

    let html = '';
    logs.forEach(log => {
        const badgeClass = getBadgeClass(log.change_type);
        const iconClass = getIconClass(log.change_type);
        const notificationIcon = log.notification_sent ?
            '<i class="fas fa-check-circle text-success ms-2" title="通知已发送"></i>' :
            '<i class="fas fa-times-circle text-warning ms-2" title="未发送通知"></i>';

        html += `
            <div class="log-entry border-start border-3 ps-3 mb-3 fade-in" style="border-color: ${getBorderColor(log.change_type)} !important;">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <i class="${iconClass} me-2"></i>
                            <strong>${log.website_name}</strong>
                            <span class="badge ${badgeClass} ms-2">${getChangeTypeText(log.change_type)}</span>
                            ${notificationIcon}
                        </div>
                        <div class="text-muted small mb-1">
                            <i class="fas fa-link me-1"></i>
                            <a href="${log.website_url}" target="_blank" class="text-decoration-none">${log.website_url}</a>
                        </div>
                        ${log.matched_keywords ? `
                            <div class="mb-1">
                                <small class="text-info">
                                    <i class="fas fa-tags me-1"></i>关键词: ${JSON.parse(log.matched_keywords).join(', ')}
                                </small>
                            </div>
                        ` : ''}
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${log.timestamp}</small>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;

    // 更新最后更新时间
    document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
}

// 获取变化类型对应的样式
function getBadgeClass(changeType) {
    switch(changeType) {
        case 'html_changed': return 'bg-primary';
        case 'keyword_matched': return 'bg-success';
        case 'content_changed': return 'bg-info';
        default: return 'bg-secondary';
    }
}

function getIconClass(changeType) {
    switch(changeType) {
        case 'html_changed': return 'fas fa-code text-primary';
        case 'keyword_matched': return 'fas fa-bullseye text-success';
        case 'content_changed': return 'fas fa-edit text-info';
        default: return 'fas fa-circle text-secondary';
    }
}

function getBorderColor(changeType) {
    switch(changeType) {
        case 'html_changed': return '#0d6efd';
        case 'keyword_matched': return '#198754';
        case 'content_changed': return '#0dcaf0';
        default: return '#6c757d';
    }
}

function getChangeTypeText(changeType) {
    switch(changeType) {
        case 'html_changed': return 'HTML变化';
        case 'keyword_matched': return '关键词匹配';
        case 'content_changed': return '内容变化';
        default: return '未知';
    }
}

// 更新状态
function updateStatus(total) {
    document.getElementById('log-count').textContent = total;
}

// 切换自动刷新
function toggleAutoRefresh() {
    const icon = document.getElementById('auto-refresh-icon');
    const text = document.getElementById('auto-refresh-text');

    if (autoRefreshEnabled) {
        // 停止自动刷新
        autoRefreshEnabled = false;
        clearInterval(autoRefreshInterval);
        icon.className = 'fas fa-play me-1';
        text.textContent = '开启自动刷新';
        showSuccess('自动刷新已停止');
    } else {
        // 开启自动刷新
        autoRefreshEnabled = true;
        autoRefreshInterval = setInterval(refreshLogs, 10000); // 10秒刷新一次
        icon.className = 'fas fa-pause me-1';
        text.textContent = '停止自动刷新';
        showSuccess('自动刷新已开启 (10秒间隔)');
    }
}

// 清空日志显示
function clearLogs() {
    const container = document.getElementById('logs-container');
    container.innerHTML = `
        <div class="text-center text-muted py-5">
            <i class="fas fa-broom fa-3x mb-3"></i>
            <p>日志显示已清空</p>
            <button class="btn btn-primary btn-sm" onclick="refreshLogs()">重新加载</button>
        </div>
    `;
    document.getElementById('log-count').textContent = '0';
}

// 显示消息
function showSuccess(message) {
    showAlert(message, 'success');
}

function showError(message) {
    showAlert(message, 'danger');
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>

<style>
.log-entry {
    transition: all 0.3s ease;
    border-radius: 0.5rem;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: rgba(0,0,0,0.02);
}

.log-entry:hover {
    background: rgba(0,0,0,0.05);
    transform: translateX(5px);
}

.fade-in {
    animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#logs-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
    font-size: 0.9rem;
    line-height: 1.5;
}
</style>
{% endblock %}